name: Build and Release ESP32 Firmware

on:
  push:
    branches: [main, master]
    paths:
      - '**.ino'
      - '.github/workflows/**'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  ARDUINO_CLI_VERSION: "0.35.3"
  SKETCH_PATH_MAIN: "securite/securite.ino"
  SKETCH_PATH_V1: "v1_basic_alarm/v1_basic_alarm.ino"
  BOARD_FQBN: "esp32:esp32:esp32"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_changed: ${{ steps.check_version.outputs.changed }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Version from Code
        id: version
        run: |
          # Extract version from v1_basic_alarm.ino (the main OTA sketch)
          VERSION=$(grep -oP '#define FW_VERSION "\K[^"]+' v1_basic_alarm/v1_basic_alarm.ino || echo "1.00")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Extracted version from code: $VERSION"

      - name: Check if Version Changed
        id: check_version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Check if this tag already exists
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Tag v$VERSION does not exist - will create new release"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: ${{ env.ARDUINO_CLI_VERSION }}

      - name: Configure Arduino CLI
        run: |
          arduino-cli config init
          arduino-cli config set library.enable_unsafe_install true

      - name: Install ESP32 Core
        run: |
          arduino-cli core update-index
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@2.0.14

      - name: List Installed Cores (Debug)
        run: arduino-cli core list

      - name: Create build directories
        run: |
          mkdir -p build/v1_basic_alarm
          mkdir -p release

      - name: Compile V1 Basic Alarm Sketch (ESP32 ONLY)
        run: |
          arduino-cli compile \
            --fqbn ${{ env.BOARD_FQBN }} \
            --output-dir build/v1_basic_alarm \
            --warnings default \
            ${{ env.SKETCH_PATH_V1 }}

      - name: Prepare Release Files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Copy the compiled binary
          cp build/v1_basic_alarm/v1_basic_alarm.ino.bin release/v1_basic_alarm_firmware.bin
          
          # Create the OTA firmware
          cp build/v1_basic_alarm/v1_basic_alarm.ino.bin release/firmware.bin
          
          # Create version file from code
          echo "$VERSION" > release/version.txt
          
          echo "=== Release files ==="
          ls -la release/
          echo ""
          echo "Version: $VERSION"
          cat release/version.txt

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-v${{ steps.version.outputs.version }}
          path: release/
          retention-days: 90

      - name: Update OTA Files in docs/
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Copy firmware.bin and version.txt to docs folder for OTA
          cp release/firmware.bin docs/firmware.bin
          cp release/version.txt docs/version.txt
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          git add docs/firmware.bin docs/version.txt
          
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to docs folder"
          else
            git commit -m "ü§ñ Auto-update OTA firmware v${VERSION}"
            git push
            echo "‚úÖ Updated docs/firmware.bin and docs/version.txt"
          fi

      - name: Create Git Tag and Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && steps.check_version.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="v${VERSION}"
          
          echo "üìå Creating tag: $TAG_NAME"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and push tag
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME - Auto-generated from FW_VERSION in code"
          git push origin "$TAG_NAME"
          
          echo "‚úÖ Tag $TAG_NAME created and pushed"

      - name: Create GitHub Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && steps.check_version.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}"
          name: "üöÄ ESP8266 Alarm v${{ steps.version.outputs.version }}"
          body: |
            ## üöÄ ESP8266 Alarm Firmware v${{ steps.version.outputs.version }}
            
            **Auto-generated release from `FW_VERSION` in code**
            
            ### üì¶ Included Files:
            | File | Description |
            |------|-------------|
            | `firmware.bin` | OTA-ready firmware (main) |
            | `v1_basic_alarm_firmware.bin` | V1 alarm with OTA support |
            | `securite_firmware.bin` | Basic security sketch |
            | `version.txt` | Version file for OTA |
            
            ### üì° OTA Update:
            Your ESP8266 devices will automatically download this update from:
            ```
            Version: https://raw.githubusercontent.com/${{ github.repository }}/main/docs/version.txt
            Firmware: https://raw.githubusercontent.com/${{ github.repository }}/main/docs/firmware.bin
            ```
            
            ### ‚ö° Manual Flash (esptool):
            ```bash
            esptool.py --port COM3 --baud 115200 write_flash 0x0 firmware.bin
            ```
            
            ---
            üìù *To create a new release, simply change `#define FW_VERSION "X.XX"` in your code and push!*
          files: |
            release/firmware.bin
            release/v1_basic_alarm_firmware.bin
            release/securite_firmware.bin
            release/version.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHANGED="${{ steps.check_version.outputs.changed }}"
          
          echo "## üìä Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| New Release | $CHANGED |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CHANGED" = "true" ]; then
            echo "‚úÖ **New release v$VERSION created!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è Version unchanged - no new release created" >> $GITHUB_STEP_SUMMARY
          fi

  verify:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Wait for GitHub to propagate changes
        run: sleep 45

      - name: Verify OTA Files
        run: |
          echo "üîç Verifying OTA files..."
          echo ""
          
          # Check version.txt
          echo "Checking version.txt..."
          HTTP_CODE=$(curl -sL -w "%{http_code}" "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/version.txt" -o /tmp/version.txt)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ version.txt accessible (HTTP $HTTP_CODE)"
            echo "   Content: $(cat /tmp/version.txt)"
          else
            echo "‚ö†Ô∏è version.txt returned HTTP $HTTP_CODE"
          fi
          
          echo ""
          
          # Check firmware.bin
          echo "Checking firmware.bin..."
          HTTP_CODE=$(curl -sL -w "%{http_code}" -o /dev/null "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/firmware.bin")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ firmware.bin accessible (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è firmware.bin returned HTTP $HTTP_CODE"
          fi
