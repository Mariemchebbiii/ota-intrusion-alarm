name: Build and Release ESP8266 Firmware

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.01)'
        required: false
        default: ''

env:
  ARDUINO_CLI_VERSION: "0.35.3"
  SKETCH_PATH_MAIN: "securite/securite.ino"
  SKETCH_PATH_V1: "v1_basic_alarm/v1_basic_alarm.ino"
  BOARD_FQBN: "esp8266:esp8266:nodemcuv2"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: ${{ env.ARDUINO_CLI_VERSION }}

      - name: Configure Arduino CLI
        run: |
          arduino-cli config init
          arduino-cli config set library.enable_unsafe_install true

      - name: Install ESP8266 Core
        run: |
          arduino-cli core update-index
          arduino-cli config add board_manager.additional_urls https://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli core update-index
          arduino-cli core install esp8266:esp8266@3.1.2

      - name: List Installed Cores (Debug)
        run: arduino-cli core list

      - name: Install Required Libraries
        run: |
          arduino-cli lib install "ArduinoOTA"
          arduino-cli lib install "ESP8266WiFi"
          arduino-cli lib install "ESP8266HTTPClient"
          arduino-cli lib install "ESP8266httpUpdate"
        continue-on-error: true

      - name: Create build directories
        run: |
          mkdir -p build/securite
          mkdir -p build/v1_basic_alarm
          mkdir -p release

      - name: Compile Securite Sketch
        run: |
          arduino-cli compile \
            --fqbn ${{ env.BOARD_FQBN }} \
            --output-dir build/securite \
            --warnings default \
            --verbose \
            ${{ env.SKETCH_PATH_MAIN }}

      - name: Compile V1 Basic Alarm Sketch
        run: |
          arduino-cli compile \
            --fqbn ${{ env.BOARD_FQBN }} \
            --output-dir build/v1_basic_alarm \
            --warnings default \
            --verbose \
            ${{ env.SKETCH_PATH_V1 }}

      - name: Prepare Release Files
        run: |
          # Copy the compiled binaries
          cp build/securite/securite.ino.bin release/securite_firmware.bin
          cp build/v1_basic_alarm/v1_basic_alarm.ino.bin release/v1_basic_alarm_firmware.bin
          
          # Create the OTA firmware (main one)
          cp build/v1_basic_alarm/v1_basic_alarm.ino.bin release/firmware.bin
          
          # List all files
          echo "=== Release files ==="
          ls -la release/

      - name: Get Version Number
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            # Extract version from v1_basic_alarm.ino
            VERSION=$(grep -oP '#define FW_VERSION "\K[^"]+' v1_basic_alarm/v1_basic_alarm.ino || echo "1.00")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update version.txt for OTA
        run: |
          echo "${{ steps.version.outputs.version }}" > release/version.txt
          echo "Version file content:"
          cat release/version.txt

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-binaries
          path: |
            release/
          retention-days: 30

      - name: Upload OTA Files to docs folder
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
        run: |
          # Copy firmware.bin and version.txt to docs folder for OTA
          cp release/firmware.bin docs/firmware.bin
          cp release/version.txt docs/version.txt
          
          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Check if there are changes
          if git diff --quiet docs/; then
            echo "No changes to docs folder"
          else
            git add docs/firmware.bin docs/version.txt
            git commit -m "ü§ñ Auto-update OTA firmware v${{ steps.version.outputs.version }}"
            git push
          fi
        continue-on-error: true

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: "ESP8266 Alarm Firmware v${{ steps.version.outputs.version }}"
          body: |
            ## üöÄ ESP8266 Alarm Firmware Release v${{ steps.version.outputs.version }}
            
            ### üì¶ Included Files:
            - `securite_firmware.bin` - Main security sketch
            - `v1_basic_alarm_firmware.bin` - V1 Basic Alarm with OTA support
            - `firmware.bin` - OTA-ready firmware (same as v1_basic_alarm)
            - `version.txt` - Version file for OTA updates
            
            ### üì° OTA Update URLs:
            After this release, your ESP8266 devices will automatically detect and download the new firmware from:
            - Version: `https://raw.githubusercontent.com/${{ github.repository }}/main/docs/version.txt`
            - Firmware: `https://raw.githubusercontent.com/${{ github.repository }}/main/docs/firmware.bin`
            
            ### üîß Manual Flash Instructions:
            1. Download `v1_basic_alarm_firmware.bin`
            2. Use **esptool** or **Arduino IDE** to flash
            3. Board: **NodeMCU 1.0 (ESP-12E Module)**
            
            ### ‚ö° Flash command (esptool):
            ```bash
            esptool.py --port COM3 --baud 115200 write_flash 0x0 v1_basic_alarm_firmware.bin
            ```
          files: |
            release/securite_firmware.bin
            release/v1_basic_alarm_firmware.bin
            release/firmware.bin
            release/version.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Latest Release (on push to main)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "Latest Build - v${{ steps.version.outputs.version }}"
          body: |
            ## üîÑ Latest Automatic Build
            
            **Version:** ${{ steps.version.outputs.version }}
            **Built from:** ${{ github.sha }}
            **Date:** ${{ github.event.head_commit.timestamp }}
            
            ### üì¶ Files:
            - `securite_firmware.bin` - Main security sketch
            - `v1_basic_alarm_firmware.bin` - V1 Basic Alarm with OTA
            - `firmware.bin` - OTA firmware
            - `version.txt` - Version for OTA check
            
            ---
            ‚ö†Ô∏è This is an automated build from the latest commit. For stable releases, use tagged versions.
          files: |
            release/securite_firmware.bin
            release/v1_basic_alarm_firmware.bin
            release/firmware.bin
            release/version.txt
          draft: false
          prerelease: true
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Verify the firmware was uploaded correctly
  verify:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Wait for GitHub Pages/Raw to update
        run: sleep 30

      - name: Verify OTA files are accessible
        run: |
          echo "Checking version.txt..."
          VERSION_RESPONSE=$(curl -sL -w "%{http_code}" "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/version.txt" -o /tmp/version.txt)
          echo "HTTP Response: $VERSION_RESPONSE"
          if [ "$VERSION_RESPONSE" = "200" ]; then
            echo "‚úÖ version.txt is accessible"
            echo "Content: $(cat /tmp/version.txt)"
          else
            echo "‚ö†Ô∏è version.txt might not be ready yet (this is normal for first run)"
          fi
          
          echo ""
          echo "Checking firmware.bin..."
          FW_RESPONSE=$(curl -sL -w "%{http_code}" -o /dev/null "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/firmware.bin")
          echo "HTTP Response: $FW_RESPONSE"
          if [ "$FW_RESPONSE" = "200" ]; then
            echo "‚úÖ firmware.bin is accessible"
          else
            echo "‚ö†Ô∏è firmware.bin might not be ready yet (this is normal for first run)"
          fi
        continue-on-error: true
